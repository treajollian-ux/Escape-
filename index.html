<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Attack - النسخة النهائية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* الصفحة الرئيسية */
        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            padding: 20px;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .resources {
            display: flex;
            gap: 15px;
        }

        .resource-item {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .icon-button {
            background: rgba(255, 255, 255, 0.1);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: none;
            color: white;
        }

        .icon-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .main-content {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .game-title {
            font-size: 48px;
            background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            margin-bottom: 30px;
            animation: titleGlow 3s ease-in-out infinite;
        }

        .animated-ship {
            width: 120px;
            height: 100px;
            margin: 0 auto 30px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        .ship-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4169E1, #87CEEB);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .bottom-menu {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 0;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            min-width: 120px;
            font-size: 16px;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .menu-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* شاشة المتجر */
        #storeScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: none;
            flex-direction: column;
            z-index: 20;
            overflow-y: auto;
            padding: 20px;
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ships-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            flex-grow: 1;
        }

        .ship-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .ship-card:hover {
            transform: translateY(-5px);
        }

        .ship-preview {
            width: 60px;
            height: 45px;
            margin: 0 auto 10px;
            background: linear-gradient(135deg, #4169E1, #87CEEB);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .ship-card.advanced .ship-preview {
            background: linear-gradient(135deg, #9B59B6, #E74C3C);
        }

        .ship-card.legendary .ship-preview {
            background: linear-gradient(135deg, #FFD700, #FF6347);
        }

        .ship-name {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .ship-stats {
            font-size: 12px;
            margin-bottom: 10px;
            color: #ccc;
        }

        .buy-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 12px;
        }

        .buy-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* واجهة اللعبة */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
            pointer-events: none;
        }

        .game-stats {
            display: flex;
            gap: 10px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        #healthBar {
            width: 150px;
            height: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #00ffff;
            position: relative;
        }

        #healthFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #ff0000 0%, #ff6b00 50%, #00ff00 100%);
            transition: width 0.3s ease;
            border-radius: 8px;
        }

        /* شاشة النصر */
        #victoryScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 100, 0, 0.9) 0%, rgba(15, 12, 41, 0.95) 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 40;
            backdrop-filter: blur(10px);
        }

        .victory-stars {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ffcc00;
        }

        .victory-title {
            font-size: 48px;
            color: #ffcc00;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
        }

        /* تأثيرات الحركة */
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 30px rgba(0, 255, 255, 0.5), 0 0 60px rgba(255, 0, 255, 0.3); }
            50% { text-shadow: 0 0 40px rgba(0, 255, 255, 0.8), 0 0 80px rgba(255, 0, 255, 0.5); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .game-title { font-size: 36px; }
            .ships-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            .menu-button {
                min-width: 100px;
                padding: 12px;
                font-size: 14px;
            }
            .resource-item {
                font-size: 12px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- واجهة اللعبة -->
        <div class="game-ui">
            <div class="game-stats">
                <div class="stat-item">🎯 <span id="scoreCount">0</span></div>
                <div class="stat-item">💰 <span id="coinsCount">0</span></div>
                <div class="stat-item">💎 <span id="gemsCount">0</span></div>
            </div>
            <div id="healthBar">
                <div id="healthFill"></div>
            </div>
            <button class="icon-button" onclick="showScreen('mainMenu')" style="pointer-events: auto;">⎋</button>
        </div>
        
        <!-- الصفحة الرئيسية -->
        <div id="mainMenu">
            <div class="top-bar">
                <div class="resources">
                    <div class="resource-item">💎 <span id="mainGemsCount">0</span></div>
                    <div class="resource-item">💰 <span id="mainCoinsCount">0</span></div>
                    <div class="resource-item">⭐ <span id="mainExpCount">0</span></div>
                </div>
                <button class="icon-button" onclick="showScreen('settingsScreen')">⚙️</button>
            </div>
            
            <div class="main-content">
                <h1 class="game-title">GALAXY ATTACK</h1>
                <div class="animated-ship">
                    <div class="ship-body"></div>
                </div>
            </div>
            
            <div class="bottom-menu">
                <button class="menu-button" onclick="showScreen('storeScreen')">
                    <span class="menu-icon">🚀</span>
                    <span>الطائرات</span>
                </button>
                <button class="menu-button" onclick="startGame()">
                    <span class="menu-icon">🎮</span>
                    <span>START</span>
                </button>
            </div>
        </div>
        
        <!-- متجر الطائرات -->
        <div id="storeScreen">
            <div class="store-header">
                <button class="menu-button" onclick="showScreen('mainMenu')" style="flex-direction: row; padding: 10px 15px;">
                    <span>⬅️</span>
                    <span>رجوع</span>
                </button>
                <div class="resources">
                    <div class="resource-item">💎 <span id="storeGemsCount">0</span></div>
                    <div class="resource-item">💰 <span id="storeCoinsCount">0</span></div>
                </div>
            </div>
            
            <h1 style="text-align: center; margin: 20px 0; color: #00ffff; font-size: 28px;">متجر الطائرات</h1>
            
            <div class="ships-grid" id="shipsGrid">
                <!-- سيتم ملؤها بالجافاسكريبت -->
            </div>
        </div>
        
        <!-- شاشة النصر -->
        <div id="victoryScreen">
            <div class="victory-stars">⭐⭐⭐</div>
            <h1 class="victory-title">VICTORY</h1>
            <div class="reward-buttons">
                <button class="menu-button" onclick="showScreen('mainMenu')">
                    <span class="menu-icon">🏠</span>
                    <span>MENU</span>
                </button>
                <button class="menu-button" onclick="nextLevel()">
                    <span class="menu-icon">➡️</span>
                    <span>NEXT</span>
                </button>
            </div>
        </div>
        
        <!-- شاشة الإعدادات -->
        <div id="settingsScreen" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30; justify-content: center; align-items: center; flex-direction: column;">
            <h1 style="color: #00ffff; margin-bottom: 30px;">الإعدادات</h1>
            <button class="menu-button" onclick="showScreen('mainMenu')">
                <span>⬅️</span>
                <span>رجوع</span>
            </button>
        </div>
    </div>

    <script>
        // === بيانات اللعبة ===
        const gameData = {
            resources: {
                gems: 15000,
                coins: 50000,
                exp: 0
            },
            currentShip: 1,
            unlockedShips: [1],
            currentLevel: 1,
            ships: []
        };

        // إنشاء 30 طائرة مختلفة
        for (let i = 1; i <= 30; i++) {
            let price, currency, health, damage, speed;
            
            if (i <= 10) {
                // الطائرات الأساسية (10,000 - 100,000 عملة)
                price = i * 10000;
                currency = "coins";
                health = 80 + (i * 5);
                damage = 10 + (i * 2);
                speed = 4 + (i * 0.2);
            } else if (i <= 20) {
                // الطائرات المتقدمة (10,000 - 50,000 ياقوت)
                price = (i - 10) * 5000;
                currency = "gems";
                health = 150 + ((i - 10) * 8);
                damage = 30 + ((i - 10) * 3);
                speed = 6 + ((i - 10) * 0.3);
            } else {
                // الطائرات الأسطورية (50,000 - 100,000 ياقوت)
                price = 50000 + ((i - 20) * 5000);
                currency = "gems";
                health = 250 + ((i - 20) * 12);
                damage = 60 + ((i - 20) * 5);
                speed = 9 + ((i - 20) * 0.4);
            }

            gameData.ships.push({
                id: i,
                name: getShipName(i),
                price: price,
                currency: currency,
                health: health,
                damage: damage,
                speed: speed
            });
        }

        function getShipName(id) {
            const names = [
                "Fighter Alpha", "Strike Eagle", "Phantom X1", "Nebula Warrior", "Cosmic Blade",
                "Star Hunter", "Galaxy Defender", "Space Invader", "Meteor Storm", "Black Hole",
                "Supernova", "Quantum Fighter", "Neutron Star", "Pulsar Rider", "Cosmos King",
                "Solar Flare", "Orion Hunter", "Andromeda", "Milky Way", "Cosmic Storm",
                "Nova Blaster", "Star Crusher", "Galaxy Hunter", "Space Warrior", "Meteor Blaster",
                "Comet Chaser", "Asteroid Destroyer", "Planet Defender", "Universe Guardian", "Cosmic Emperor"
            ];
            return names[id - 1] || `Ship ${id}`;
        }

        // === عناصر اللعبة ===
        let player, enemies, bullets, enemyBullets, particles, stars, powerUps;
        let score = 0;
        let gameActive = false;
        let lastEnemySpawn = 0;
        let lastBossSpawn = 0;
        let enemySpawnRate = 1000; // ميلي ثانية بين ظهور الأعداء
        let bossSpawnRate = 5000; // كل 5 ثواني يظهر وحش كبير

        // === تهيئة اللعبة ===
        function init() {
            setupGameCanvas();
            showScreen('mainMenu');
            updateResourcesDisplay();
            createStoreItems();
            
            // إعداد التحكم باللمس
            setupTouchControls();
        }

        function setupGameCanvas() {
            const canvas = document.getElementById('gameCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        function setupTouchControls() {
            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);
            
            // للتحكم بالفأرة على الكمبيوتر
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
        }

        let touchId = null;
        let playerOffsetX = 0;
        let playerOffsetY = -50; // الطائرة فوق الإصبع

        function handleTouchStart(e) {
            e.preventDefault();
            if (!gameActive) return;
            
            const touch = e.touches[0];
            touchId = touch.identifier;
            movePlayer(touch.clientX, touch.clientY);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!gameActive || !touchId) return;
            
            for (let touch of e.touches) {
                if (touch.identifier === touchId) {
                    movePlayer(touch.clientX, touch.clientY);
                    break;
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            touchId = null;
        }

        function handleMouseDown(e) {
            if (!gameActive) return;
            movePlayer(e.clientX, e.clientY);
        }

        function handleMouseMove(e) {
            if (!gameActive || !e.buttons) return;
            movePlayer(e.clientX, e.clientY);
        }

        function handleMouseUp(e) {
            // لا شيء
        }

        function movePlayer(x, y) {
            if (!player) return;
            
            player.x = x + playerOffsetX;
            player.y = y + playerOffsetY;
            
            // الحدود
            player.x = Math.max(player.width/2, Math.min(canvas.width - player.width/2, player.x));
            player.y = Math.max(player.height/2, Math.min(canvas.height - player.height/2, player.y));
        }

        function showScreen(screenName) {
            // إخفاء جميع الشاشات
            document.querySelectorAll('[id$="Screen"], #mainMenu').forEach(screen => {
                screen.style.display = 'none';
            });
            
            // إظهار الشاشة المطلوبة
            document.getElementById(screenName).style.display = 'flex';
            
            // إذا كانت شاشة اللعبة، ابدأ اللعبة
            if (screenName === 'gameCanvas') {
                if (!gameActive) {
                    startGame();
                }
            }
        }

        function updateResourcesDisplay() {
            document.getElementById('gemsCount').textContent = gameData.resources.gems.toLocaleString();
            document.getElementById('coinsCount').textContent = gameData.resources.coins.toLocaleString();
            document.getElementById('mainGemsCount').textContent = gameData.resources.gems.toLocaleString();
            document.getElementById('mainCoinsCount').textContent = gameData.resources.coins.toLocaleString();
            document.getElementById('mainExpCount').textContent = gameData.resources.exp.toLocaleString();
            document.getElementById('storeGemsCount').textContent = gameData.resources.gems.toLocaleString();
            document.getElementById('storeCoinsCount').textContent = gameData.resources.coins.toLocaleString();
        }

        function createStoreItems() {
            const grid = document.getElementById('shipsGrid');
            grid.innerHTML = '';

            gameData.ships.forEach(ship => {
                const isUnlocked = gameData.unlockedShips.includes(ship.id);
                const isOwned = isUnlocked;
                const canAfford = gameData.resources[ship.currency] >= ship.price;
                const shipType = ship.id <= 10 ? 'basic' : ship.id <= 20 ? 'advanced' : 'legendary';

                const card = document.createElement('div');
                card.className = `ship-card ${shipType}`;
                card.innerHTML = `
                    <div class="ship-preview"></div>
                    <div class="ship-name">${ship.name}</div>
                    <div class="ship-stats">
                        <div>❤️ ${ship.health}</div>
                        <div>💥 ${ship.damage}</div>
                        <div>⚡ ${ship.speed.toFixed(1)}</div>
                    </div>
                    ${isOwned ? 
                        `<div style="color: #00ff00; font-weight: bold; font-size: 12px;">✓ مملوكة</div>
                         ${ship.id === gameData.currentShip ? '<div style="color: #00ffff; font-size: 11px;">محددة</div>' : 
                           `<button class="buy-button" onclick="selectShip(${ship.id})" style="background: linear-gradient(135deg, #00b4db, #0083b0);">تحديد</button>`}` :
                        `<button class="buy-button" onclick="buyShip(${ship.id})" ${!canAfford ? 'disabled' : ''}>
                            🛒 ${ship.price.toLocaleString()} ${ship.currency === 'coins' ? '💰' : '💎'}
                        </button>`
                    }
                `;
                grid.appendChild(card);
            });
        }

        function buyShip(shipId) {
            const ship = gameData.ships.find(s => s.id === shipId);
            if (gameData.resources[ship.currency] >= ship.price) {
                gameData.resources[ship.currency] -= ship.price;
                gameData.unlockedShips.push(shipId);
                gameData.currentShip = shipId;
                updateResourcesDisplay();
                createStoreItems();
            }
        }

        function selectShip(shipId) {
            if (gameData.unlockedShips.includes(shipId)) {
                gameData.currentShip = shipId;
                createStoreItems();
            }
        }

        function startGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // إخفاء واجهة اللعبة مؤقتاً
            document.querySelector('.game-ui').style.display = 'none';
            
            // تهيئة اللاعب
            const currentShip = gameData.ships.find(s => s.id === gameData.currentShip);
            player = {
                x: canvas.width / 2,
                y: canvas.height - 100,
                width: 50,
                height: 40,
                speed: currentShip.speed,
                health: currentShip.health,
                maxHealth: currentShip.health,
                damage: currentShip.damage,
                lastShot: 0,
                fireRate: 200, // ميلي ثانية بين الطلقات
                weapons: ['single'] // الأسلحة المتاحة
            };

            enemies = [];
            bullets = [];
            enemyBullets = [];
            particles = [];
            powerUps = [];
            stars = [];
            score = 0;
            gameActive = true;

            // إنشاء النجوم
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * 2 + 1
                });
            }

            // إظهار واجهة اللعبة
            setTimeout(() => {
                document.querySelector('.game-ui').style.display = 'flex';
            }, 100);

            // بدء حلقة اللعبة
            gameLoop(ctx, canvas);
        }

        function gameLoop(ctx, canvas) {
            if (!gameActive) return;

            // مسح الشاشة
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // تحديث وعرض النجوم
            updateStars(ctx, canvas);

            // إنشاء الأعداء
            spawnEnemies(canvas);

            // تحديث العناصر
            updatePlayer(canvas);
            updateEnemies(canvas);
            updateBullets();
            updateEnemyBullets();
            updatePowerUps();
            updateParticles();

            // الرسم
            drawPlayer(ctx);
            drawEnemies(ctx);
            drawBullets(ctx);
            drawEnemyBullets(ctx);
            drawPowerUps(ctx);
            drawParticles(ctx);

            // تحديث واجهة المستخدم
            updateGameUI();

            requestAnimationFrame(() => gameLoop(ctx, canvas));
        }

        function updateStars(ctx, canvas) {
            ctx.fillStyle = 'white';
            stars.forEach(star => {
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function spawnEnemies(canvas) {
            const now = Date.now();
            
            // أعداء عاديين
            if (now - lastEnemySpawn > enemySpawnRate) {
                createEnemy(canvas);
                lastEnemySpawn = now;
                
                // تقليل وقت ظهور الأعداء مع زيادة الصعوبة
                enemySpawnRate = Math.max(300, 1000 - (gameData.currentLevel * 50));
            }
            
            // وحش كبير كل 5 مستويات
            if (gameData.currentLevel % 5 === 0 && now - lastBossSpawn > bossSpawnRate) {
                createBoss(canvas);
                lastBossSpawn = now;
            }
        }

        function createEnemy(canvas) {
            const enemyType = Math.random() < 0.7 ? 'small' : 'medium';
            const size = enemyType === 'small' ? 25 : 35;
            const health = enemyType === 'small' ? 20 : 40;
            const speed = enemyType === 'small' ? 2 : 1.5;
            
            enemies.push({
                x: Math.random() * (canvas.width - size) + size/2,
                y: -size,
                width: size,
                height: size,
                speed: speed,
                health: health,
                maxHealth: health,
                type: enemyType,
                lastShot: 0
            });
        }

        function createBoss(canvas) {
            enemies.push({
                x: canvas.width / 2,
                y: -100,
                width: 80,
                height: 80,
                speed: 0.5,
                health: 200,
                maxHealth: 200,
                type: 'boss',
                lastShot: 0
            });
        }

        function updatePlayer(canvas) {
            // إطلاق النار تلقائياً
            const now = Date.now();
            if (now - player.lastShot > player.fireRate) {
                shoot();
                player.lastShot = now;
            }
        }

        function updateEnemies(canvas) {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                
                // حركة الأعداء
                if (enemy.type === 'boss') {
                    // حركة متعرجة للوحش الكبير
                    enemy.x += Math.sin(Date.now() / 1000) * 2;
                }
                enemy.y += enemy.speed;

                // إطلاق النار من الأعداء
                const now = Date.now();
                if (now - enemy.lastShot > 1000 && Math.random() < 0.01) {
                    enemyShoot(enemy);
                    enemy.lastShot = now;
                }

                // التحقق من الاصطدام باللاعب
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < (player.width/2 + enemy.width/2)) {
                    player.health -= enemy.type === 'boss' ? 20 : 10;
                    createExplosion(enemy.x, enemy.y, enemy.type === 'boss' ? 20 : 10);
                    enemies.splice(i, 1);
                    updateHealthBar();
                    continue;
                }

                // إزالة الأعداء الذين خرجوا من الشاشة
                if (enemy.y > canvas.height + 100) {
                    enemies.splice(i, 1);
                }
            }
        }

        function shoot() {
            const weapon = player.weapons[player.weapons.length - 1];
            
            if (weapon === 'single') {
                // طلقة واحدة
                bullets.push({
                    x: player.x,
                    y: player.y - 20,
                    width: 4,
                    height: 12,
                    speed: 10,
                    damage: player.damage
                });
            } else if (weapon === 'double') {
                // طلقتين
                bullets.push({
                    x: player.x - 15,
                    y: player.y - 15,
                    width: 4,
                    height: 12,
                    speed: 10,
                    damage: player.damage
                });
                bullets.push({
                    x: player.x + 15,
                    y: player.y - 15,
                    width: 4,
                    height: 12,
                    speed: 10,
                    damage: player.damage
                });
            } else if (weapon === 'laser') {
                // ليزر قوي
                bullets.push({
                    x: player.x,
                    y: player.y - 25,
                    width: 8,
                    height: 20,
                    speed: 12,
                    damage: player.damage * 2
                });
            }
        }

        function enemyShoot(enemy) {
            enemyBullets.push({
                x: enemy.x,
                y: enemy.y + enemy.height/2,
                width: 6,
                height: 6,
                speed: 4,
                damage: enemy.type === 'boss' ? 15 : 5
            });
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.y -= bullet.speed;

                // التحقق من اصطدام الرصاصة بالأعداء
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < (bullet.width + enemy.width/2)) {
                        enemy.health -= bullet.damage;
                        bullets.splice(i, 1);
                        
                        if (enemy.health <= 0) {
                            score += enemy.type === 'boss' ? 500 : enemy.type === 'medium' ? 50 : 20;
                            gameData.resources.coins += enemy.type === 'boss' ? 100 : enemy.type === 'medium' ? 10 : 5;
                            
                            // فرصة إسقاط ترقية
                            if (Math.random() < 0.2) {
                                createPowerUp(enemy.x, enemy.y);
                            }
                            
                            enemies.splice(j, 1);
                            createExplosion(enemy.x, enemy.y, enemy.type === 'boss' ? 30 : 15);
                        }
                        break;
                    }
                }

                // إزالة الرصاصات التي خرجت من الشاشة
                if (bullet.y < -20) {
                    bullets.splice(i, 1);
                }
            }
        }

        function updateEnemyBullets() {
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.y += bullet.speed;

                // التحقق من اصطدام الرصاصة باللاعب
                const dx = player.x - bullet.x;
                const dy = player.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < (player.width/2 + bullet.width)) {
                    player.health -= bullet.damage;
                    enemyBullets.splice(i, 1);
                    updateHealthBar();
                    createExplosion(bullet.x, bullet.y, 5);
                    continue;
                }

                // إزالة الرصاصات التي خرجت من الشاشة
                if (bullet.y > canvas.height + 20) {
                    enemyBullets.splice(i, 1);
                }
            }
        }

        function createPowerUp(x, y) {
            const types = ['health', 'weapon', 'shield'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            powerUps.push({
                x: x,
                y: y,
                width: 20,
                height: 20,
                speed: 2,
                type: type
            });
        }

        function updatePowerUps() {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.y += powerUp.speed;

                // التحقق من الاصطدام باللاعب
                const dx = player.x - powerUp.x;
                const dy = player.y - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < (player.width/2 + powerUp.width/2)) {
                    applyPowerUp(powerUp.type);
                    powerUps.splice(i, 1);
                    continue;
                }

                // إزالة الترقيآت التي خرجت من الشاشة
                if (powerUp.y > canvas.height + 20) {
                    powerUps.splice(i, 1);
                }
            }
        }

        function applyPowerUp(type) {
            switch(type) {
                case 'health':
                    player.health = Math.min(player.maxHealth, player.health + 30);
                    updateHealthBar();
                    break;
                case 'weapon':
                    if (player.weapons.length === 1) {
                        player.weapons.push('double');
                    } else if (player.weapons.length === 2) {
                        player.weapons.push('laser');
                    }
                    player.fireRate = Math.max(50, player.fireRate - 50);
                    break;
                case 'shield':
                    // يمكن إضافة تأثير الدرع هنا
                    break;
            }
        }

        function createExplosion(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 3 + 1,
                    speedX: (Math.random() - 0.5) * 4,
                    speedY: (Math.random() - 0.5) * 4,
                    life: 30,
                    color: Math.random() < 0.5 ? '#ff0000' : '#ffff00'
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                particle.life--;

                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function drawPlayer(ctx) {
            ctx.fillStyle = '#4169E1';
            ctx.beginPath();
            ctx.moveTo(player.x, player.y - 20);
            ctx.lineTo(player.x - 25, player.y + 20);
            ctx.lineTo(player.x + 25, player.y + 20);
            ctx.closePath();
            ctx.fill();

            // تأثير المحركات
            ctx.fillStyle = '#ff6b00';
            ctx.fillRect(player.x - 20, player.y + 15, 10, 8);
            ctx.fillRect(player.x + 10, player.y + 15, 10, 8);
        }

        function drawEnemies(ctx) {
            enemies.forEach(enemy => {
                if (enemy.type === 'boss') {
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // عيون الوحش الكبير
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(enemy.x - 15, enemy.y - 10, 8, 0, Math.PI * 2);
                    ctx.arc(enemy.x + 15, enemy.y - 10, 8, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = enemy.type === 'medium' ? '#ff6600' : '#ff0000';
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.width/2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        function drawBullets(ctx) {
            ctx.fillStyle = '#00ffff';
            bullets.forEach(bullet => {
                ctx.fillRect(bullet.x - bullet.width/2, bullet.y, bullet.width, bullet.height);
            });
        }

        function drawEnemyBullets(ctx) {
            ctx.fillStyle = '#ff0000';
            enemyBullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.width, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawPowerUps(ctx) {
            powerUps.forEach(powerUp => {
                ctx.fillStyle = 
                    powerUp.type === 'health' ? '#00ff00' :
                    powerUp.type === 'weapon' ? '#ffff00' : '#00ffff';
                ctx.beginPath();
                ctx.arc(powerUp.x, powerUp.y, powerUp.width/2, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawParticles(ctx) {
            particles.forEach(particle => {
                ctx.globalAlpha = particle.life / 30;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        function updateGameUI() {
            document.getElementById('scoreCount').textContent = score;
            document.getElementById('coinsCount').textContent = gameData.resources.coins;
            document.getElementById('gemsCount').textContent = gameData.resources.gems;
            
            updateHealthBar();

            // التحقق من نهاية اللعبة
            if (player.health <= 0) {
                gameOver();
            }
            
            // التحقق من الفوز (لا توجد أعداء)
            if (enemies.length === 0 && score > 0) {
                showVictory();
            }
        }

        function updateHealthBar() {
            const healthPercent = (player.health / player.maxHealth) * 100;
            document.getElementById('healthFill').style.width = `${healthPercent}%`;
        }

        function gameOver() {
            gameActive = false;
            alert(`انتهت اللعبة! النقاط: ${score}`);
            showScreen('mainMenu');
            updateResourcesDisplay();
        }

        function showVictory() {
            gameActive = false;
            gameData.resources.coins += score;
            gameData.resources.gems += Math.floor(score / 100);
            gameData.currentLevel++;
            updateResourcesDisplay();
            document.getElementById('victoryScreen').style.display = 'flex';
        }

        function nextLevel() {
            document.getElementById('victoryScreen').style.display = 'none';
            startGame();
        }

        // بدء اللعبة
        window.onload = init;
    </script>
</body>
</html>
